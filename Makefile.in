################################################
# Makefile for Formosa BBS v1.4.0              #
################################################

SUBDIRS := lib src csbbs util bbsweb
CLEANDIRS := $(SUBDIRS) bbsweb/util src/util
PHONY_TARGETS := all debug clean distclean install install_once update
VERSION := 1.4.0
HOMEBBS := @prefix@

.PHONY: $(SUBDIRS) $(CLEANDIRS) $(CLEANDIRS_CLEAN) $(PHONY_TARGETS)

all: $(SUBDIRS)

$(SUBDIRS):
	$(MAKE) -C $@ $(target)

debug: target := debug
debug: $(SUBDIRS)

update: install
	kill `cat /tmp/formosa.23`
	$(HOMEBBS)/bin/bbsd 23

config: distclean
	./autogen.sh
	./configure

config_bbs3: distclean
	./autogen.sh
	CFLAGS=-DNSYSUBBS3 ./configure --prefix=/apps/bbs

install_once: target := install_once
install_once: $(SUBDIRS)

CLEANDIRS_CLEAN = $(addsuffix .clean, $(CLEANDIRS))
$(CLEANDIRS_CLEAN):
	if [ -f $(basename $@)/Makefile ]; then \
		echo  "Cleaning $(basename $@) ..."; \
		$(MAKE) -C $(basename $@) clean; \
	fi;

clean: $(CLEANDIRS_CLEAN)

distclean: clean
	@for i in $(CLEANDIRS); do \
		echo  "Dist Cleaning $$i ...";\
		(cd $$i; rm -f *~ DEADJOE core a.out Makefile proto.h;) \
	done
#	@(cd innbbsd; ${MAKE} clean; cd innd; ${MAKE} clean)
#	@rm -f bbshome/HTML/*.html
	@-rm -f src/tsbbsproto.h
	@-rm -f lib/libproto.h
	@-rm -f *~
	@-rm -f configure config.cache config.status config.log

install: target := install
install: $(SUBDIRS)

